<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Leaflet GeoTIFF Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Preconnect to CDNs for better performance -->
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  
  <!-- Tabler Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css" />

  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    body { margin:0; padding:0; }
    #map { height: 100vh; width: 100vw; }
    
    /* Loading screen */
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #4c7ef3;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Controls on the right */
    .controls {
      position: absolute;
      top: 10px;
      left: 60px; /* เพิ่มระยะห่างจากปุ่มซูม */
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      max-width: 300px;
      max-height: 80vh;
      overflow-y: auto;
      transition: transform 0.3s ease;
    }
    
    .controls.hidden {
      transform: translateX(-390px);
    }
    
    .toggle-controls {
      position: absolute;
      top: 75px;
      left: 10px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 5px;
      background: #4c7ef3;
      color: white;
      cursor: pointer;
      font-size: 18px;
      z-index: 1001;
    }
    
    /* Toolbar on the right */
    .toolbar {
      position: absolute;
      top: 10px;
      right: 60px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 5px;
      padding: 5px;
    }
    
    .toolbar-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 5px;
      background: #4c7ef3;
      color: white;
      cursor: pointer;
      font-size: 18px;
    }
    
    .toolbar-btn:hover {
      background: #3b5fc9;
    }
    
    .toolbar-btn.active {
      background: #2a4fa7;
    }
    
    .control-group {
      margin-bottom: 12px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    input[type="range"] {
      width: 100%;
    }
    
    .opacity-value {
      display: inline-block;
      width: 40px;
      text-align: right;
    }
    
    button {
      padding: 8px 12px;
      background: #4c7ef3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 5px;
    }
    
    button:hover {
      background: #3b5fc9;
    }
    
    button.remove-btn {
      background: #ff5252;
      padding: 4px 8px;
      font-size: 12px;
    }
    
    button.remove-btn:hover {
      background: #e00000;
    }
    
    .layer-list {
      margin-top: 15px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    
    .layer-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding: 6px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    
    .layer-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 8px;
    }
    
    .layer-controls {
      display: flex;
      align-items: center;
    }
    
    .visibility-toggle {
      margin-right: 8px;
    }
    
    /* Info Panel - Moved to right side */
    .info-panel {
      position: absolute;
      top: 60px;
      right: 10px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      width: 350px;
      max-height: 70vh;
      overflow-y: auto;
      display: none;
    }
    
    .info-panel h3 {
      margin-top: 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    .info-content {
      margin-bottom: 15px;
    }
    
    .info-tabs {
      display: flexible;
      border-bottom: 1px solid #eee;
      margin-bottom: 15px;
    }
    
    .info-tab {
      padding: 8px 15px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    
    .info-tab.active {
      border-bottom: 2px solid #4c7ef3;
      color: #4c7ef3;
    }
    
    .info-editor {
      width: 100%;
      min-height: 200px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      font-family: monospace;
      resize: vertical;
    }
    
    .info-preview {
      border: 1px solid #eee;
      border-radius: 4px;
      padding: 15px;
      min-height: 200px;
      overflow: auto;
    }
    
    .info-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    
    /* Marker styling */
    .custom-marker {
      background-color: #4c7ef3;
      border: 2px solid white;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Marker popup styling */
    .marker-popup-content {
      max-width: 300px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    /* Base map opacity controls */
    .basemap-opacity {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    
    /* URL input styling */
    .url-input-group {
      display: flex;
      gap: 5px;
      margin-top: 10px;
    }
    
    .url-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .url-load-btn {
      padding: 8px 12px;
      background: #4c7ef3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 10px;
      color: #4c7ef3;
    }
    
    .kml-info {
      background: #f0f7ff;
      border: 1px solid #c5e1ff;
      border-radius: 4px;
      padding: 10px;
      margin-top: 10px;
    }
    
    /* Marker color dropdown */
    .marker-color-dropdown {
      position: absolute;
      top: 60px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
      flex-direction: row;
      gap: 5px;
    }
    
    .color-option {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    .color-option:hover {
      border-color: #333;
    }
    
    .color-option.selected {
      border-color: #333;
      transform: scale(1.1);
    }
    
    /* Import/Export buttons */
    .import-export-buttons {
      margin-top: 15px;
      border-top: 1px solid #eee;
      padding-top: 10px;
      display: flex;
      flex-direction: row;
      gap: 8px;
    }
    
    /* Markdown guide */
    .markdown-guide {
      background: #f9f9f9;
      border: 1px solid #eee;
      border-radius: 4px;
      padding: 10px;
      margin-top: 10px;
      font-size: 12px;
    }
    
    .markdown-guide summary {
      cursor: pointer;
      font-weight: bold;
    }
    
    /* Popup content styling */
    .popup-content {
      max-width: 300px;
      max-height: 400px;
      overflow: auto;
    }
    
    .popup-content iframe {
      width: 100%;
      height: 200px;
      border: none;
      border-radius: 4px;
    }
    
    .popup-content img {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen">
    <div class="spinner"></div>
    <p>กำลังโหลดแอปพลิเคชัน...</p>
  </div>
  
  <!-- Toggle Controls Button -->
  <button class="toggle-controls" id="toggleControlsBtn" title="แสดงแผงควบคุม">
    <i class="ti ti-layout-sidebar-right"></i>
  </button>
  
  <!-- Controls on the right -->
  <div class="controls" id="controlsPanel">
    <div class="control-group">
      <label for="geotiffInput">เลือกไฟล์ GeoTIFF (หลายไฟล์ได้):</label>
      <input type="file" id="geotiffInput" accept=".tif,.tiff,.kml" multiple>
    </div>
    
    <div class="control-group">
      <label for="urlInput">โหลดจาก URL (KML):</label>
      <div class="url-input-group">
        <input type="text" id="urlInput" class="url-input" placeholder="https://example.com/file.kml">
        <button id="loadUrlBtn" class="url-load-btn">โหลด</button>
      </div>
      <div id="loadingIndicator" class="loading">
        <i class="ti ti-loader"></i> กำลังโหลด...
      </div>
      <div class="kml-info">
        <small>หมายเหตุ: เนื่องจากข้อจำกัดด้านความปลอดภัย การโหลด KML จากโดเมนอื่นอาจไม่ทำงานในบางเบราว์เซอร์</small>
      </div>
    </div>
    
    <div class="control-group">
      <label for="opacitySlider">ความโปร่งใส GeoTIFF: <span id="opacityValue" class="opacity-value">100%</span></label>
      <input type="range" id="opacitySlider" min="0" max="100" value="100">
    </div>
    
    <div class="basemap-opacity">
      <label for="basemapOpacitySlider">ความโปร่งใสแผนที่: <span id="basemapOpacityValue" class="opacity-value">100%</span></label>
      <input type="range" id="basemapOpacitySlider" min="0" max="100" value="100">
    </div>
    
    <div class="layer-list" id="layerList">
      <h3>เลเยอร์ที่โหลด</h3>
      <div id="noLayersMessage">ยังไม่มีเลเยอร์</div>
    </div>
    
    <!-- Import/Export buttons -->
    <div class="import-export-buttons">
      <button id="exportGeoJSONBtn">Export GeoJSON</button>
      <label for="importGeoJSONInput" style="display: block; margin-top: 8px;">
        <input type="file" id="importGeoJSONInput" accept=".geojson,.json" style="display: none;">
        <span style="display: block; text-align: center; padding: 8px 12px; background: #4c7ef3; color: white; border-radius: 4px; cursor: pointer;">Import GeoJSON</span>
      </label>
    </div>
  </div>
  
  <!-- Marker color dropdown -->
  <div class="marker-color-dropdown" id="markerColorDropdown">
    <div class="color-option selected" data-color="ylw" style="background-image: url('http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png'); background-size: contain;"></div>
    <div class="color-option" data-color="blue" style="background-image: url('http://maps.google.com/mapfiles/kml/pushpin/blue-pushpin.png'); background-size: contain;"></div>
    <div class="color-option" data-color="grn" style="background-image: url('http://maps.google.com/mapfiles/kml/pushpin/grn-pushpin.png'); background-size: contain;"></div>
    <div class="color-option" data-color="ltblu" style="background-image: url('http://maps.google.com/mapfiles/kml/pushpin/ltblu-pushpin.png'); background-size: contain;"></div>
    <div class="color-option" data-color="pink" style="background-image: url('http://maps.google.com/mapfiles/kml/pushpin/pink-pushpin.png'); background-size: contain;"></div>
    <div class="color-option" data-color="purple" style="background-image: url('http://maps.google.com/mapfiles/kml/pushpin/purple-pushpin.png'); background-size: contain;"></div>
    <div class="color-option" data-color="red" style="background-image: url('http://maps.google.com/mapfiles/kml/pushpin/red-pushpin.png'); background-size: contain;"></div>
    <div class="color-option" data-color="wht" style="background-image: url('http://maps.google.com/mapfiles/kml/pushpin/wht-pushpin.png'); background-size: contain;"></div>
  </div>
  
  <!-- Toolbar on the right -->
  <div class="toolbar">
    <button class="toolbar-btn" id="addMarkerBtn" title="เพิ่มจุด">
      <i class="ti ti-map-pin"></i>
    </button>
    <button class="toolbar-btn" id="infoPanelBtn" title="แสดงข้อมูลสถานที่">
      <i class="ti ti-info-circle"></i>
    </button>
    <button class="toolbar-btn" id="deleteMarkerBtn" title="ลบจุด">
      <i class="ti ti-trash"></i>
    </button>
  </div>
  
  <!-- Info Panel -->
  <div class="info-panel" id="infoPanel">
    <h3>รายละเอียดสถานที่</h3>
    
    <div class="info-tabs">
      <div class="info-tab active" data-tab="edit">แก้ไข</div>
      <div class="info-tab" data-tab="preview">แสดงผล</div>
      <div class="info-tab" data-tab="help">วิธีใช้</div>
    </div>
    
    <div class="info-content" id="editTab">
      <textarea class="info-editor" id="infoEditor" placeholder="ใส่รายละเอียดสถานที่ (รองรับ Markdown และ HTML)"></textarea>
    </div>
    
    <div class="info-content" id="previewTab" style="display: none;">
      <div class="info-preview" id="infoPreview"></div>
    </div>
    
    <div class="info-content" id="helpTab" style="display: none;">
      <div class="markdown-guide">
        <h4>คู่มือการใช้งาน Markdown และ HTML</h4>
        <p>คุณสามารถใช้ Markdown และ HTML เพื่อจัดรูปแบบเนื้อหาใน popup ได้:</p>
        
        <h5>Markdown พื้นฐาน:</h5>
        <ul>
          <li><strong>ข้อความหนา</strong>: **ข้อความ** หรือ __ข้อความ__</li>
          <li><em>ข้อความเอียง</em>: *ข้อความ* หรือ _ข้อความ_</li>
          <li>รายการ:<br>
            - รายการ 1<br>
            - รายการ 2</li>
          <li>[ลิงก์](https://example.com)</li>
          <li>![รูปภาพ](https://example.com/image.jpg)</li>
        </ul>
        
        <h5>HTML ที่รองรับ:</h5>
        <ul>
          <li>&lt;iframe&gt; (จาก YouTube, Google Drive, ฯลฯ)</li>
          <li>&lt;img&gt;, &lt;video&gt;, &lt;audio&gt;</li>
          <li>&lt;a&gt;, &lt;strong&gt;, &lt;em&gt;, &lt;br&gt;</li>
          <li>&lt;div&gt;, &lt;span&gt; พร้อม style</li>
        </ul>
        
        <h5>ตัวอย่าง iframe YouTube:</h5>
        <pre>&lt;iframe width="100%" height="200" src="https://www.youtube.com/embed/VIDEO_ID" frameborder="0" allowfullscreen&gt;&lt;/iframe&gt;</pre>
        
        <h5>ตัวอย่าง iframe Google Drive:</h5>
        <pre>&lt;iframe src="https://drive.google.com/file/d/FILE_ID/preview" width="100%" height="200"&gt;&lt;/iframe&gt;</pre>
      </div>
    </div>
    
    <div class="info-actions">
      <button id="deleteMarkerBtnPanel">ลบจุด</button>
      <div>
        <button id="cancelInfoBtn">ยกเลิก</button>
        <button id="saveInfoBtn">บันทึก</button>
      </div>
    </div>
  </div>
  
  <div id="map"></div>

  <!-- Load scripts asynchronously -->
  <script>
    // Function to load scripts dynamically
    function loadScript(src, onload) {
      const script = document.createElement('script');
      script.src = src;
      script.onload = onload;
      script.async = true;
      document.head.appendChild(script);
    }

    // Load scripts in sequence
    loadScript('https://unpkg.com/leaflet@1.7.1/dist/leaflet.js', function() {
      loadScript('https://unpkg.com/georaster', function() {
        loadScript('https://unpkg.com/georaster-layer-for-leaflet', function() {
          // All scripts loaded, initialize the application
          initializeApp();
        });
      });
    });

    // Main application initialization
    function initializeApp() {
      // เริ่มต้นแผนที่โดยตั้งค่าที่ประเทศไทย
      let map = L.map("map").setView([13.736717, 100.523186], 6);

      // Base layers - ใช้แผนที่แบบไฮบริดฟรีจากแหล่งต่างๆ
      let baseLayers = {
        "Google Hybrid (Free)": L.tileLayer(
          "https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}", {
            maxZoom: 20,
            subdomains: ['mt0','mt1','mt2','mt3'],
            attribution: "Map data © Google"
          }
        ),
        "OpenStreetMap": L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          { attribution: "© OSM contributors" }
        )
      };

      // เพิ่มแผนที่พื้นฐานเริ่มต้น (Google Hybrid)
      baseLayers["Google Hybrid (Free)"].addTo(map);
      
      // เก็บค่า opacity ปัจจุบันของแผนที่พื้นฐาน
      let currentBasemapOpacity = 1.0;
      
      // เพิ่มตัวควบคุมเลเยอร์
      L.control.layers(baseLayers).addTo(map);

      // เก็บเลเยอร์ GeoTIFF ทั้งหมด
      const geotiffLayers = new Map();
      let layerCounter = 0;
      
      // เก็บข้อมูล marker
      let customMarkers = [];
      let currentMarker = null;
      let infoPanelVisible = false;
      let selectedMarkerColor = 'ylw'; // Default color
      let isAddingMarker = false;

      // ฟังก์ชันเคลียร์ URL
      function clearUrlInput() {
        document.getElementById('urlInput').value = '';
      }

      // ฟังก์ชันโหลด GeoTIFF จาก ArrayBuffer
      function loadGeoTIFFFromArrayBuffer(arrayBuffer, fileName) {
        parseGeoraster(arrayBuffer).then(georaster => {
          // สร้างเลเยอร์ใหม่ด้วยค่าความโปร่งใสปัจจุบัน
          const opacity = document.getElementById('opacitySlider').value / 100;
          
          const geotiffLayer = new GeoRasterLayer({
            georaster: georaster,
            opacity: opacity,
            resolution: 256,
            pixelValuesToColorFn: values => {
              // ฟังก์ชันปรับสี (สามารถปรับแต่งได้ตามต้องการ)
              const [r, g, b] = values;
              return `rgb(${r}, ${g}, ${b})`;
            }
          });

          // เพิ่มเลเยอร์ลงในแผนที่
          geotiffLayer.addTo(map);
          
          // เก็บข้อมูลเลเยอร์
          const layerId = `layer-${layerCounter++}`;
          geotiffLayers.set(layerId, {
            layer: geotiffLayer,
            name: fileName,
            visible: true,
            type: 'geotiff'
          });
          
          // 1. เมื่อเพิ่ม geotiff ให้ไปยังตำแหน่งตามพิกัดของภาพนั้นแบบดูเต็มเฟรม
          const bounds = geotiffLayer.getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds);
          }
          
          // อัปเดต UI
          updateLayerList();
          
        }).catch(error => {
          console.error("Error loading GeoTIFF:", error);
          alert("ไม่สามารถโหลดไฟล์ GeoTIFF ได้: " + error.message);
        });
      }

      // ฟังก์ชันโหลด KML จาก URL
      function loadKMLFromURL(url, fileName) {
        // แสดง indicator การโหลด
        document.getElementById('loadingIndicator').style.display = 'block';
        
        // ใช้ CORS proxy ทางเลือก
        const corsProxy = "https://api.allorigins.win/raw?url=";
        
        fetch(corsProxy + encodeURIComponent(url))
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.text();
          })
          .then(kmlText => {
            // ซ่อน indicator การโหลด
            document.getElementById('loadingIndicator').style.display = 'none';
            
            // ตรวจสอบว่าเป็นไฟล์ KML จริงหรือไม่
            if (!kmlText.includes('<kml') && !kmlText.includes('</kml>')) {
              throw new Error('ไฟล์ไม่ใช่รูปแบบ KML ที่ถูกต้อง');
            }
            
            // สร้าง marker เพื่อแสดงข้อมูล KML
            const kmlLayer = L.marker([15, 100], {
              icon: L.divIcon({
                className: 'kml-marker',
                html: `<div style="background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-width: 300px;">
                         <h4 style="margin: 0 0 10px 0; color: #4c7ef3;">KML File Loaded</h4>
                         <p style="margin: 0 0 8px 0;"><strong>ชื่อ:</strong> ${fileName || 'KML from URL'}</p>
                         <p style="margin: 0 0 8px 0;"><strong>ที่มา:</strong> ${url}</p>
                         <p style="margin: 0; font-size: 12px; color: #666;">KML ถูกโหลดแล้ว แต่ไม่สามารถแสดงบนแผนที่ได้เนื่องจากข้อจำกัดด้านความปลอดภัยของเบราว์เซอร์</p>
                       </div>`,
                iconSize: [320, 150],
                iconAnchor: [160, 75]
              })
            }).addTo(map);
            
            // เก็บข้อมูลเลเยอร์
            const layerId = `layer-${layerCounter++}`;
            geotiffLayers.set(layerId, {
              layer: kmlLayer,
              name: fileName || 'KML from URL',
              visible: true,
              type: 'kml'
            });
            
            // อัปเดต UI
            updateLayerList();
            
            // ย้ายแผนที่ไปยังตำแหน่งที่เหมาะสม
            map.setView([20, 100], 3);
            
            // เคลียร์ URL หลังจากโหลดเสร็จ
            clearUrlInput();
          })
          .catch(error => {
            // ซ่อน indicator การโหลด
            document.getElementById('loadingIndicator').style.display = 'none';
            
            console.error("Error loading KML:", error);
            
            // แสดงข้อมูลเกี่ยวกับ KML แม้ว่าจะโหลดไม่สำเร็จ
            const kmlLayer = L.marker([15, 100], {
              icon: L.divIcon({
                className: 'kml-marker',
                html: `<div style="background: #fff3f3; padding: 15px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-width: 300px; border: 1px solid #ff5252;">
                         <h4 style="margin: 0 0 10px 0; color: #ff5252;">ไม่สามารถโหลด KML</h4>
                         <p style="margin: 0 0 8px 0;"><strong>URL:</strong> ${url}</p>
                         <p style="margin: 0 0 8px 0;"><strong>ข้อผิดพลาด:</strong> ${error.message}</p>
                         <p style="margin: 0; font-size: 12px; color: #666;">เนื่องจากข้อจำกัดความปลอดภัยของเบราว์เซอร์</p>
                       </div>`,
                iconSize: [320, 150],
                iconAnchor: [160, 75]
              })
            }).addTo(map);
            
            // เก็บข้อมูลเลเยอร์
            const layerId = `layer-${layerCounter++}`;
            geotiffLayers.set(layerId, {
              layer: kmlLayer,
              name: 'KML Error: ' + (fileName || 'KML from URL'),
              visible: true,
              type: 'kml-error'
            });
            
            // อัปเดต UI
            updateLayerList();
            
            // เคลียร์ URL หลังจากโหลดเสร็จ
            clearUrlInput();
          });
      }

      // อัปเดตรายการเลเยอร์ใน UI
      function updateLayerList() {
        const layerList = document.getElementById('layerList');
        const noLayersMessage = document.getElementById('noLayersMessage');
        
        // ลบรายการเลเยอร์เก่าทั้งหมด (ยกเว้นหัวข้อและข้อความไม่มีเลเยอร์)
        const items = layerList.querySelectorAll('.layer-item');
        items.forEach(item => item.remove());
        
        if (geotiffLayers.size === 0) {
          noLayersMessage.style.display = 'block';
          return;
        }
        
        noLayersMessage.style.display = 'none';
        
        // เพิ่มรายการเลเยอร์ใหม่
        geotiffLayers.forEach((layerData, layerId) => {
          const layerItem = document.createElement('div');
          layerItem.className = 'layer-item';
          
          layerItem.innerHTML = `
            <div class="layer-name" title="${layerData.name}">${layerData.name}</div>
            <div class="layer-controls">
              <input type="checkbox" class="visibility-toggle" ${layerData.visible ? 'checked' : ''}>
              <button class="remove-btn" data-layer-id="${layerId}">ลบ</button>
            </div>
          `;
          
          layerList.appendChild(layerItem);
          
          // เพิ่ม event listener สำหรับปุ่มลบ
          const removeBtn = layerItem.querySelector('.remove-btn');
          removeBtn.addEventListener('click', function() {
            const idToRemove = this.getAttribute('data-layer-id');
            removeLayer(idToRemove);
          });
          
          // เพิ่ม event listener สำหรับการแสดง/ซ่อน
          const visibilityToggle = layerItem.querySelector('.visibility-toggle');
          visibilityToggle.addEventListener('change', function() {
            toggleLayerVisibility(layerId, this.checked);
          });
        });
      }

      // ลบเลเยอร์
      function removeLayer(layerId) {
        if (geotiffLayers.has(layerId)) {
          const layerData = geotiffLayers.get(layerId);
          map.removeLayer(layerData.layer);
          geotiffLayers.delete(layerId);
          updateLayerList();
        }
      }

      // เปิด/ปิดการแสดงเลเยอร์
      function toggleLayerVisibility(layerId, isVisible) {
        if (geotiffLayers.has(layerId)) {
          const layerData = geotiffLayers.get(layerId);
          layerData.visible = isVisible;
          
          if (isVisible) {
            map.addLayer(layerData.layer);
          } else {
            map.removeLayer(layerData.layer);
          }
        }
      }

      // อัปโหลดไฟล์
      document.getElementById("geotiffInput").addEventListener("change", function(e) {
        const files = e.target.files;
        if (!files || files.length === 0) return;
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          
          // ตรวจสอบประเภทไฟล์
          if (file.name.toLowerCase().endsWith('.kml')) {
            // โหลดไฟล์ KML
            const reader = new FileReader();
            reader.onload = function() {
              const kmlText = reader.result;
              
              // สร้าง marker เพื่อแสดงข้อมูล KML
              const kmlLayer = L.marker([15, 100], {
                icon: L.divIcon({
                  className: 'kml-marker',
                  html: `<div style="background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-width: 300px;">
                           <h4 style="margin: 0 0 10px 0; color: #4c7ef3;">KML File Loaded</h4>
                           <p style="margin: 0 0 8px 0;"><strong>ชื่อ:</strong> ${file.name}</p>
                           <p style="margin: 0; font-size: 12px; color: #666;">KML ถูกโหลดแล้ว แต่ไม่สามารถแสดงบนแผนที่ได้เนื่องจากข้อจำกัดด้านความปลอดภัยของเบราว์เซอร์</p>
                         </div>`,
                  iconSize: [320, 120],
                  iconAnchor: [160, 60]
                })
              }).addTo(map);
              
              // เก็บข้อมูลเลเยอร์
              const layerId = `layer-${layerCounter++}`;
              geotiffLayers.set(layerId, {
                layer: kmlLayer,
                name: file.name,
                visible: true,
                type: 'kml'
              });
              
              // อัปเดต UI
              updateLayerList();
            };
            reader.readAsText(file);
          } else if (file.name.toLowerCase().endsWith('.tif') || 
                     file.name.toLowerCase().endsWith('.tiff')) {
            // โหลดไฟล์ GeoTIFF
            const reader = new FileReader();
            reader.onload = function() {
              loadGeoTIFFFromArrayBuffer(reader.result, file.name);
            };
            reader.onerror = function() {
              alert("เกิดข้อผิดพลาดในการอ่านไฟล์ " + file.name);
            };
            reader.readAsArrayBuffer(file);
          } else {
            alert("ไฟล์ " + file.name + " ไม่ใช่ไฟล์ GeoTIFF หรือ KML (.tif, .tiff, .kml)");
          }
        }
        
        // รีเซ็ต input เพื่อให้สามารถเลือกไฟล์เดิมอีกครั้งได้
        e.target.value = '';
      });

      // โหลดจาก URL
      document.getElementById("loadUrlBtn").addEventListener("click", function() {
        const url = document.getElementById('urlInput').value.trim();
        
        if (!url) {
          alert("กรุณาใส่ URL");
          return;
        }
        
        // ตรวจสอบประเภทไฟล์จาก URL
        if (url.toLowerCase().endsWith('.kml')) {
          loadKMLFromURL(url, 'KML from URL');
        } else {
          alert("URL ต้องเป็นไฟล์ KML (.kml)");
        }
      });

      // ควบคุมความโปร่งใสของ GeoTIFF
      const opacitySlider = document.getElementById('opacitySlider');
      const opacityValue = document.getElementById('opacityValue');
      
      opacitySlider.addEventListener('input', function() {
        const opacity = this.value / 100;
        opacityValue.textContent = `${this.value}%`;
        
        // อัปเดตความโปร่งใสของทุกเลเยอร์ GeoTIFF
        geotiffLayers.forEach(layerData => {
          if (layerData.type === 'geotiff') {
            layerData.layer.setOpacity(opacity);
          }
        });
      });

      // ควบคุมความโปร่งใสของแผนที่พื้นฐาน
      const basemapOpacitySlider = document.getElementById('basemapOpacitySlider');
      const basemapOpacityValue = document.getElementById('basemapOpacityValue');
      
      basemapOpacitySlider.addEventListener('input', function() {
        const opacity = this.value / 100;
        basemapOpacityValue.textContent = `${this.value}%`;
        currentBasemapOpacity = opacity;
        
        // อัปเดตความโปร่งใสของแผนที่พื้นฐาน
        map.getContainer().style.opacity = opacity;
      });

      // เพิ่ม marker ใหม่
  function addMarker(lat, lng, content = '', color = selectedMarkerColor) {
  // สร้างไอคอนตามสีที่เลือก
  const iconUrl = `http://maps.google.com/mapfiles/kml/pushpin/${color}-pushpin.png`;
  const icon = L.icon({
    iconUrl: iconUrl,
    iconSize: [26, 26],       // ✅ ขนาดเดียว
    iconAnchor: [12, 36],     // ✅ ปลายหมุด
    popupAnchor: [0, -36]     // ✅ popup อยู่ด้านบน
  });

  // ✅ ทำให้ marker ลากได้
  const marker = L.marker([lat, lng], { 
    icon: icon,
    draggable: true 
  }).addTo(map);

  // เก็บข้อมูล content
  marker.content = content;

  // เพิ่ม popup ถ้ามีข้อมูล
  if (content) {
    marker.bindPopup(`
      <div class="popup-content">
        ${content}
      </div>
    `, { maxWidth: 400 });
  }

  // ✅ Event: ลากแล้วปล่อย -> อัพเดทตำแหน่ง
  marker.on('dragend', function(e) {
    const newPos = e.target.getLatLng();
    console.log("ตำแหน่งใหม่:", newPos.lat, newPos.lng);
    // ถ้าคุณมีระบบบันทึก database ก็ update ตรงนี้ได้
  });

  // เพิ่ม event listener สำหรับการคลิก
  marker.on('click', function() {
    if (infoPanelVisible) {
      showInfoPanel(marker);
    }
  });

  // เพิ่ม marker ลงในรายการ
  customMarkers.push(marker);

  return marker;
}


      // แสดงแผงข้อมูล marker
      function showInfoPanel(marker) {
        currentMarker = marker;
        
        // แสดงข้อมูลใน editor
        document.getElementById('infoEditor').value = marker.content || '';
        
        // อัปเดต preview
        updatePreview();
        
        // แสดงแผงข้อมูล
        document.getElementById('infoPanel').style.display = 'block';
        infoPanelVisible = true;
      }

      // อัปเดต preview
      function updatePreview() {
        const content = document.getElementById('infoEditor').value;
        document.getElementById('infoPreview').innerHTML = marked.parse(content);
      }

      // ซ่อนแผงข้อมูล
      function hideInfoPanel() {
        document.getElementById('infoPanel').style.display = 'none';
        infoPanelVisible = false;
        currentMarker = null;
      }

      // ลบ marker ปัจจุบัน
      function deleteCurrentMarker() {
        if (currentMarker) {
          // ลบ marker ออกจากแผนที่
          map.removeLayer(currentMarker);
          
          // ลบ marker ออกจากรายการ
          const index = customMarkers.indexOf(currentMarker);
          if (index !== -1) {
            customMarkers.splice(index, 1);
          }
          
          // ซ่อนแผงข้อมูล
          hideInfoPanel();
        }
      }

      // สลับแท็บในแผงข้อมูล
      function switchTab(tabName) {
        // ซ่อนแท็บทั้งหมด
        document.querySelectorAll('.info-content').forEach(tab => {
          tab.style.display = 'none';
        });
        
        // แสดงแท็บที่เลือก
        document.getElementById(tabName + 'Tab').style.display = 'block';
        
        // อัปเดตสถานะแท็บที่ active
        document.querySelectorAll('.info-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelector(`.info-tab[data-tab="${tabName}"]`).classList.add('active');
        
        // อัปเดต preview ถ้าเป็นแท็บ preview
        if (tabName === 'preview') {
          updatePreview();
        }
      }

      // Export GeoJSON
      function exportGeoJSON() {
        // สร้าง GeoJSON feature collection
        const features = customMarkers.map(marker => {
          const latlng = marker.getLatLng();
          return {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [latlng.lng, latlng.lat]
            },
            properties: {
              content: marker.content,
              color: marker.options.icon.options.iconUrl.match(/pushpin\/(.*)-pushpin/)[1]
            }
          };
        });
        
        const geoJSON = {
          type: 'FeatureCollection',
          features: features
        };
        
        // สร้าง blob และดาวน์โหลด
        const blob = new Blob([JSON.stringify(geoJSON, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'markers.geojson';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Import GeoJSON
      function importGeoJSON(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const geoJSON = JSON.parse(e.target.result);
            
            // ตรวจสอบว่าเป็น GeoJSON ที่ถูกต้อง
            if (geoJSON.type !== 'FeatureCollection' || !Array.isArray(geoJSON.features)) {
              throw new Error('รูปแบบ GeoJSON ไม่ถูกต้อง');
            }
            
            // ลบ marker เดิมทั้งหมด
            customMarkers.forEach(marker => map.removeLayer(marker));
            customMarkers = [];
            
            // เพิ่ม marker จาก GeoJSON
            geoJSON.features.forEach(feature => {
              if (feature.geometry.type === 'Point') {
                const coords = feature.geometry.coordinates;
                const content = feature.properties.content || '';
                const color = feature.properties.color || 'ylw';
                
                addMarker(coords[1], coords[0], content, color);
              }
            });
            
            alert(`นำเข้า ${geoJSON.features.length} จุดเรียบร้อยแล้ว`);
          } catch (error) {
            console.error('Error importing GeoJSON:', error);
            alert('ไม่สามารถนำเข้าไฟล์ได้: ' + error.message);
          }
        };
        reader.readAsText(file);
      }

      // Event listeners สำหรับ UI
      document.getElementById('toggleControlsBtn').addEventListener('click', function() {
        const controlsPanel = document.getElementById('controlsPanel');
        controlsPanel.classList.toggle('hidden');
        
        // เปลี่ยนไอคอนตามสถานะ
        const icon = this.querySelector('i');
        if (controlsPanel.classList.contains('hidden')) {
          icon.className = 'ti ti-layout-sidebar-left';
          this.title = 'ซ่อนแผงควบคุม';
        } else {
          icon.className = 'ti ti-layout-sidebar-right';
          this.title = 'แสดงแผงควบคุม';
        }
      });

      document.getElementById('addMarkerBtn').addEventListener('click', function() {
        isAddingMarker = !isAddingMarker;
        
        if (isAddingMarker) {
          this.classList.add('active');
          map.getContainer().style.cursor = 'crosshair';
        } else {
          this.classList.remove('active');
          map.getContainer().style.cursor = '';
        }
      });

      document.getElementById('infoPanelBtn').addEventListener('click', function() {
        infoPanelVisible = !infoPanelVisible;
        
        if (!infoPanelVisible) {
          hideInfoPanel();
        }
      });

      document.getElementById('deleteMarkerBtn').addEventListener('click', function() {
        if (currentMarker) {
          deleteCurrentMarker();
        }
      });

      // Event listener สำหรับการคลิกแผนที่เพื่อเพิ่ม marker
      map.on('click', function(e) {
        if (isAddingMarker) {
          // เพิ่ม marker ใหม่
          const marker = addMarker(e.latlng.lat, e.latlng.lng, '', selectedMarkerColor);
          
          // แสดงแผงข้อมูล
          showInfoPanel(marker);
          
          // ปิดโหมดเพิ่ม marker
          isAddingMarker = false;
          document.getElementById('addMarkerBtn').classList.remove('active');
          map.getContainer().style.cursor = '';
        }
      });

      // Event listeners สำหรับแผงข้อมูล
      document.querySelectorAll('.info-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          switchTab(this.getAttribute('data-tab'));
        });
      });

      document.getElementById('saveInfoBtn').addEventListener('click', function() {
        if (currentMarker) {
          // อัปเดตเนื้อหา marker
          const content = document.getElementById('infoEditor').value;
          currentMarker.content = content;
          
          // อัปเดต popup
          if (content) {
            currentMarker.bindPopup(`
              <div class="popup-content">
                ${content}
              </div>
            `, { maxWidth: 400 });
          } else {
            currentMarker.unbindPopup();
          }
          
          // ซ่อนแผงข้อมูล
          hideInfoPanel();
        }
      });

      document.getElementById('cancelInfoBtn').addEventListener('click', function() {
        hideInfoPanel();
      });

      document.getElementById('deleteMarkerBtnPanel').addEventListener('click', function() {
        deleteCurrentMarker();
      });

      // Event listener สำหรับการแก้ไข content
      document.getElementById('infoEditor').addEventListener('input', function() {
        // อัปเดต preview แบบ real-time
        if (document.getElementById('previewTab').style.display !== 'none') {
          updatePreview();
        }
      });

      // Event listeners สำหรับการเลือกสี marker
      document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
          // อัปเดตสีที่เลือก
          selectedMarkerColor = this.getAttribute('data-color');
          
          // อัปเดต UI
          document.querySelectorAll('.color-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          this.classList.add('selected');
          
          // ซ่อน dropdown
          document.getElementById('markerColorDropdown').style.display = 'none';
        });
      });

      // Event listener สำหรับการแสดง/ซ่อน dropdown สี
      document.getElementById('addMarkerBtn').addEventListener('click', function(e) {
        if (isAddingMarker) {
          const dropdown = document.getElementById('markerColorDropdown');
          const rect = this.getBoundingClientRect();
          
          dropdown.style.top = (rect.bottom + window.scrollY + 5) + 'px';
          dropdown.style.right = (window.innerWidth - rect.right) + 'px';
          dropdown.style.display = 'flex';
        }
      });

      // Event listener สำหรับการคลิกนอก dropdown เพื่อซ่อน
      document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('markerColorDropdown');
        const addBtn = document.getElementById('addMarkerBtn');
        
        if (dropdown.style.display === 'flex' && 
            !dropdown.contains(e.target) && 
            !addBtn.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });

      // Event listeners สำหรับ import/export
      document.getElementById('exportGeoJSONBtn').addEventListener('click', exportGeoJSON);
      
      document.getElementById('importGeoJSONInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          importGeoJSON(file);
        }
        // รีเซ็ต input
        e.target.value = '';
      });

      // ซ่อน loading screen เมื่อโหลดเสร็จ
      document.getElementById('loadingScreen').style.display = 'none';
    }
  </script>
</body>
</html>
